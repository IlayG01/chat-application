<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat App</title>
</head>
<body>
<h1>Welcome to chat room {{ room_id }}</h1>
<div id="messages"></div>
<form id="message_input_form">
    <label for="message_input"></label>
    <input id="message_input" type="text" placeholder="Enter your message here">
    <button>Submit</button>
</form>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.2/socket.io.js"></script>
<script>
    // DISCONNECTING FROM SERVER
    window.onbeforeunload = function (){
        socket.emit('leave_room', {
            username: "{{ username }}",
            room_id: "{{ room_id }}"
        });
    };

    const server = "http://127.0.0.1:5000";
    const socket = io.connect(server);

    // CONNECTING TO SERVER
    socket.on('connect', function () {
        // calling a socketio function
        socket.emit('join_room', {
            username: "{{ username }}",
            room_id: "{{ room_id }}"
        });
        // naming the input form
        let message_input = document.getElementById('message_input');
        document.getElementById('message_input_form').onsubmit = function(e) {
            e.preventDefault(); //preventing refreshing
            let message_content = message_input.value.trim();
            if (message_content.length) {
                socket.emit('send_message', {
                    username: "{{ username }}",
                    message: message_content
                })
            }
            message_input.value = "";
            message_input.focus();
        };
    });

    // JOINING THE ROOM
    socket.on('join_room_announcement', function (data) {
        console.log(data);
        // announcing in the chat
        const newNode = document.createElement('div');
        newNode.innerHTML = `${data.username} has joined the room`;
        document.getElementById('messages').appendChild(newNode);
    });

    // WRITING RECEIVED MESSAGE FROM SERVER
    socket.on('message_announcement', function (data) {
        console.log(data);
        const newNode = document.createElement('div');
        newNode.innerHTML = `${data.username}: ${data.message}`;
        document.getElementById('messages').appendChild(newNode);
    });

    // LEAVING THE ROOM
    socket.on('leave_room_announcement', function (data) {
        console.log(data);
        // announcing in the chat
        const newNode = document.createElement('div');
        newNode.innerHTML = `${data.username} has left the room`;
        document.getElementById('messages').appendChild(newNode);
    });
</script>
</html>